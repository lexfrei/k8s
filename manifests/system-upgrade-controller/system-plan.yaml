---
apiVersion: v1
kind: Secret
metadata:
  name: system-upgrade-secret
  namespace: system-upgrade
type: Opaque
stringData:
  upgrade.sh: |
    #!/bin/sh
    set -e

    echo "Starting system upgrade on $(hostname)"

    # Update package lists
    apt-get update

    # Perform upgrade with automatic yes to prompts
    DEBIAN_FRONTEND=noninteractive apt-get upgrade --yes --option Dpkg::Options::="--force-confdef" --option Dpkg::Options::="--force-confold"

    # Clean up unnecessary packages
    apt-get autoremove --yes
    apt-get autoclean

    # Check if reboot is required
    if [ -f /var/run/reboot-required ]; then
      echo "Reboot required after upgrade"
      # Sync filesystems before reboot
      sync
      reboot
    else
      echo "Upgrade completed successfully, no reboot required"
    fi
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: system-upgrade-server
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  drain:
    force: true
    ignoreDaemonSets: true
    deleteEmptyDirData: true
    timeout: 900
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: In
        values:
          - "true"
  serviceAccountName: system-upgrade
  secrets:
    - name: system-upgrade-secret
      path: /host/run/system-upgrade/secrets
  version: plucky
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/upgrade.sh
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: system-upgrade-agent
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  drain:
    force: true
    ignoreDaemonSets: true
    deleteEmptyDirData: true
    timeout: 900
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  serviceAccountName: system-upgrade
  secrets:
    - name: system-upgrade-secret
      path: /host/run/system-upgrade/secrets
  version: plucky
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/upgrade.sh
