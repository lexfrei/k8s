apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: monitoring
data:
  vector.yaml: |
    data_dir: /vector-data-dir

    sources:
      kubernetes_logs:
        type: kubernetes_logs
        auto_partial_merge: true
        exclude_paths_glob_patterns:
          - "**/kube-system/coredns*"

      # journald source disabled - distroless image doesn't have journalctl
      # TODO: Switch to debian-based image or use fluent-bit for journal logs
      # journald:
      #   type: journald
      #   current_boot_only: true
      #   data_dir: /vector-data-dir
      #   exclude_units:
      #     - systemd-timesyncd.service
      #     - systemd-resolved.service
      #     - systemd-udevd.service
      #     - systemd-networkd.service
      #     - NetworkManager.service

    transforms:
      k8s_metadata:
        type: remap
        inputs:
          - kubernetes_logs
        source: |
          .namespace = .kubernetes.pod_namespace
          .pod = .kubernetes.pod_name
          .container = .kubernetes.container_name
          .node = .kubernetes.pod_node_name

    sinks:
      # Send Kubernetes logs to Loki
      loki:
        type: loki
        inputs:
          - k8s_metadata
        endpoint: http://loki.monitoring.svc:3100
        encoding:
          codec: json
          timestamp_format: rfc3339
        labels:
          namespace: "{{ namespace }}"
          pod: "{{ pod }}"
          container: "{{ container }}"
          node: "{{ node }}"
        compression: snappy
        healthcheck:
          enabled: true
