apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: alertmanager-config
  namespace: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao
  target:
    name: alertmanager-config
    template:
      engineVersion: v2
      data:
        alertmanager.yaml: |
          global:
            resolve_timeout: 5m

          route:
            receiver: telegram
            group_by:
              - alertname
              - namespace
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h

          receivers:
            - name: telegram
              telegram_configs:
                - bot_token: "{{ .bot_token }}"
                  chat_id: {{ .chat_id }}
                  parse_mode: HTML
                  message: |-
                    {{ "{{" }} range .Alerts {{ "}}" }}
                    <b>{{ "{{" }} .Labels.alertname {{ "}}" }}</b> [{{ "{{" }} .Status | toUpper {{ "}}" }}]
                    {{ "{{" }} .Annotations.summary {{ "}}" }}
                    {{ "{{" }} end {{ "}}" }}
  data:
    - secretKey: bot_token
      remoteRef:
        key: secret/data/alertmanager/telegram
        property: bot_token
    - secretKey: chat_id
      remoteRef:
        key: secret/data/alertmanager/telegram
        property: chat_id
