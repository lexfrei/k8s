apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: filesystem-optimization
  namespace: argo
spec:
  serviceAccountName: argo-workflow

  arguments:
    parameters:
      - name: node-role
        value: ""  # empty = all nodes, or specify "control-plane" / "worker"

  entrypoint: main

  templates:
    - name: main
      steps:
        - - name: get-nodes
            template: list-nodes

        - - name: optimize-node
            template: optimize-single-node
            arguments:
              parameters:
                - name: node
                  value: "{{item}}"
            withParam: "{{steps.get-nodes.outputs.result}}"
            parallelism: 1

    - name: list-nodes
      script:
        image: rancher/kubectl:v1.34.1
        command: [bash]
        source: |
          if [ -z "{{workflow.parameters.node-role}}" ]; then
            kubectl get nodes \
              --output jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))'
          else
            kubectl get nodes \
              --selector node-role.kubernetes.io/{{workflow.parameters.node-role}}= \
              --output jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))'
          fi

    - name: optimize-single-node
      inputs:
        parameters:
          - name: node

      steps:
        - - name: run-optimization
            template: privileged-pod
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

    - name: privileged-pod
      inputs:
        parameters:
          - name: node

      script:
        image: ubuntu:noble
        command: [bash]
        source: |
          #!/bin/bash
          set -e

          echo "==================================="
          echo "Optimizing filesystem on: {{inputs.parameters.node}}"
          echo "==================================="

          cat > /tmp/setup.sh <<'SCRIPT'
          #!/bin/sh
          set -e

          echo "Configuring filesystem and VM parameters on $(hostname)"

          SYSCTL_FILE="/etc/sysctl.d/99-k8s-filesystem.conf"

          # Check if already configured
          if [ -f "$SYSCTL_FILE" ]; then
            if grep -q "^vm.swappiness = 1" "$SYSCTL_FILE" && \
               grep -q "^vm.dirty_ratio = 10" "$SYSCTL_FILE" && \
               grep -q "^fs.inotify.max_user_watches = 524288" "$SYSCTL_FILE"; then
              echo "Filesystem parameters already configured, verifying runtime values..."
              CURRENT_SWAPPINESS=$(sysctl -n vm.swappiness)
              CURRENT_DIRTY=$(sysctl -n vm.dirty_ratio)
              CURRENT_WATCHES=$(sysctl -n fs.inotify.max_user_watches)
              if [ "$CURRENT_SWAPPINESS" = "1" ] && [ "$CURRENT_DIRTY" = "10" ] && [ "$CURRENT_WATCHES" = "524288" ]; then
                echo "Runtime values already correct, skipping"
                exit 0
              fi
            fi
          fi

          # Create sysctl configuration
          cat > "$SYSCTL_FILE" <<'EOF'
          # Filesystem and VM configuration for Kubernetes nodes

          # Memory Management
          # -----------------
          # Minimize swapping (critical for K8s performance)
          # Even with swap disabled, this prevents swapping tmpfs/cgroups
          vm.swappiness = 1

          # Dirty page writeback (I/O performance)
          # Start background writeback at 5% dirty pages
          vm.dirty_background_ratio = 5

          # Force synchronous writeback at 10% dirty pages
          # Lower than default (20%) for more predictable I/O
          vm.dirty_ratio = 10

          # Dirty page cache timeout (centiseconds = 15 seconds)
          # Write dirty pages to disk after 15s instead of 30s
          vm.dirty_expire_centisecs = 1500

          # Writeback daemon wakeup interval (centiseconds = 5 seconds)
          vm.dirty_writeback_centisecs = 500

          # File Handle Limits
          # ------------------
          # Maximum number of file handles (system-wide)
          # Default is often too low for K8s clusters
          fs.file-max = 2097152

          # Maximum number of inotify watches per user
          # Kubernetes components (kubelet, fluentd) need many watches
          fs.inotify.max_user_watches = 524288

          # Maximum inotify instances per user
          fs.inotify.max_user_instances = 512

          # Maximum queued events
          fs.inotify.max_queued_events = 65536

          # Async I/O Limits
          # ----------------
          # Maximum concurrent async I/O requests
          # Important for databases (PostgreSQL, MongoDB, MySQL)
          fs.aio-max-nr = 1048576

          # Prevent overly aggressive oom-killer
          # Let memory pressure handling work before OOM
          vm.panic_on_oom = 0

          # Memory overcommit strategy
          # 0 = heuristic (allow reasonable overcommit)
          vm.overcommit_memory = 0
          EOF

          # Apply settings immediately
          sysctl --system

          # Verify critical settings
          FINAL_SWAPPINESS=$(sysctl -n vm.swappiness)
          FINAL_DIRTY=$(sysctl -n vm.dirty_ratio)
          FINAL_WATCHES=$(sysctl -n fs.inotify.max_user_watches)
          FINAL_FILE_MAX=$(sysctl -n fs.file-max)

          if [ "$FINAL_SWAPPINESS" = "1" ] && [ "$FINAL_DIRTY" = "10" ] && \
             [ "$FINAL_WATCHES" = "524288" ] && [ "$FINAL_FILE_MAX" = "2097152" ]; then
            echo "Filesystem parameters successfully configured:"
            echo "  vm.swappiness = $FINAL_SWAPPINESS"
            echo "  vm.dirty_ratio = $FINAL_DIRTY"
            echo "  vm.dirty_background_ratio = $(sysctl -n vm.dirty_background_ratio)"
            echo "  fs.file-max = $FINAL_FILE_MAX"
            echo "  fs.inotify.max_user_watches = $FINAL_WATCHES"
            echo "  fs.aio-max-nr = $(sysctl -n fs.aio-max-nr)"
          else
            echo "ERROR: Failed to configure filesystem parameters"
            echo "  vm.swappiness = $FINAL_SWAPPINESS (expected: 1)"
            echo "  vm.dirty_ratio = $FINAL_DIRTY (expected: 10)"
            echo "  fs.inotify.max_user_watches = $FINAL_WATCHES (expected: 524288)"
            echo "  fs.file-max = $FINAL_FILE_MAX (expected: 2097152)"
            exit 1
          fi
          SCRIPT

          chmod +x /tmp/setup.sh
          chroot /host /tmp/setup.sh

          echo "Filesystem optimization completed on {{inputs.parameters.node}}"

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      securityContext:
        privileged: true

      volumeMounts:
        - name: host-root
          mountPath: /host

      volumes:
        - name: host-root
          hostPath:
            path: /
            type: Directory
