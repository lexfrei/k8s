apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: watchdog-setup
  namespace: argo
spec:
  serviceAccountName: argo-workflow

  arguments:
    parameters:
      - name: node-role
        value: ""  # empty = all nodes, or specify "control-plane" / "worker"

  entrypoint: main

  templates:
    - name: main
      steps:
        # Get list of nodes matching the role
        - - name: get-nodes
            template: list-nodes

        # Process each node sequentially
        - - name: setup-node
            template: setup-single-node
            arguments:
              parameters:
                - name: node
                  value: "{{item}}"
            withParam: "{{steps.get-nodes.outputs.result}}"
            # Sequential setup to avoid potential issues
            parallelism: 1

    # Get list of nodes with specific role (or all nodes if role is empty)
    - name: list-nodes
      script:
        image: rancher/kubectl:v1.31.3
        command: [bash]
        source: |
          if [ -z "{{workflow.parameters.node-role}}" ]; then
            # Get all nodes
            kubectl get nodes \
              --output jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))'
          else
            # Get nodes with specific role
            kubectl get nodes \
              --selector node-role.kubernetes.io/{{workflow.parameters.node-role}}= \
              --output jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))'
          fi

    # Setup watchdog on a single node
    - name: setup-single-node
      inputs:
        parameters:
          - name: node

      steps:
        # Run setup script on the node
        - - name: run-setup
            template: privileged-pod
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

    # Privileged pod that runs on specific node with host filesystem access
    - name: privileged-pod
      inputs:
        parameters:
          - name: node

      script:
        image: ubuntu:noble
        command: [bash]
        source: |
          #!/bin/bash
          set -e

          echo "==================================="
          echo "Setting up watchdog on: {{inputs.parameters.node}}"
          echo "==================================="

          # Watchdog setup script (from plans/watchdog-setup.yaml)
          cat > /tmp/setup.sh <<'SCRIPT'
          #!/bin/sh
          set -e

          echo "Setting up watchdog on $(hostname)"

          # Check if watchdog is already configured and running
          if systemctl is-active --quiet watchdog; then
            echo "Watchdog is already active, checking configuration..."
            if grep -q "^watchdog-device = /dev/watchdog" /etc/watchdog.conf 2>/dev/null && \
               grep -q "^max-load-1 = 40" /etc/watchdog.conf 2>/dev/null; then
              echo "Watchdog is already properly configured, skipping"
              exit 0
            fi
          fi

          # Update package lists
          apt-get update

          # Install watchdog package
          DEBIAN_FRONTEND=noninteractive apt-get install --yes watchdog

          # Configure watchdog
          cat > /etc/watchdog.conf <<'EOF'
          # Watchdog configuration for Kubernetes nodes
          watchdog-device = /dev/watchdog
          # Increased timeout to prevent false positives during high load
          watchdog-timeout = 120

          # System load monitoring (very conservative for 4-core system)
          # Allow much higher load before triggering (cores * 10)
          max-load-1 = 40
          max-load-5 = 30
          max-load-15 = 20

          # Check interval (longer = less sensitive)
          interval = 30

          # Logging
          realtime = yes
          priority = 1

          # No test or repair binaries needed - just monitor load
          EOF

          # Load bcm2835_wdt module (Raspberry Pi hardware watchdog)
          if ! lsmod | grep -q bcm2835_wdt; then
            modprobe bcm2835_wdt
          fi

          # Make watchdog module persistent
          if ! grep -q "bcm2835_wdt" /etc/modules; then
            echo "bcm2835_wdt" >> /etc/modules
          fi

          # Enable and start watchdog service
          systemctl enable watchdog
          systemctl restart watchdog

          # Verify watchdog is running
          if systemctl is-active --quiet watchdog; then
            echo "Watchdog successfully configured and started"
          else
            echo "ERROR: Watchdog failed to start"
            exit 1
          fi
          SCRIPT

          chmod +x /tmp/setup.sh

          # Execute setup script via chroot to host filesystem
          chroot /host /tmp/setup.sh

          echo "Watchdog setup completed on {{inputs.parameters.node}}"

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      # Privileged mode and host access required for system configuration
      securityContext:
        privileged: true

      volumeMounts:
        - name: host-root
          mountPath: /host

      volumes:
        - name: host-root
          hostPath:
            path: /
            type: Directory
