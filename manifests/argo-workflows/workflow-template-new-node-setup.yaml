apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: new-node-setup
  namespace: argo
spec:
  serviceAccountName: argo-workflow

  arguments:
    parameters:
      - name: node-role
        value: ""  # empty = all nodes, or specify "control-plane" / "worker"

  entrypoint: main

  templates:
    - name: main
      steps:
        # Get list of nodes
        - - name: get-nodes
            template: list-nodes

        # Configure each node
        - - name: setup-node
            template: setup-single-node
            arguments:
              parameters:
                - name: node
                  value: "{{item}}"
            withParam: "{{steps.get-nodes.outputs.result}}"

    # Get list of all nodes (simplified - always returns all nodes)
    - name: list-nodes
      container:
        image: alpine/k8s:1.34.1
        command: [sh, -c]
        args:
          - |
            kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
            jq -R . | jq -s .

    # Setup single node (all configurations)
    - name: setup-single-node
      inputs:
        parameters:
          - name: node
      steps:
        # Step 1: Kernel panic settings
        - - name: kernel-panic
            template: configure-kernel-panic
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

        # Step 2: Filesystem optimization
        - - name: filesystem
            template: configure-filesystem
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

        # Step 3: Watchdog setup
        - - name: watchdog
            template: configure-watchdog
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

        # Step 4: DNS fallback configuration
        - - name: dns-fallback
            template: configure-dns-fallback
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

        # Step 5: DNS timeouts optimization
        - - name: dns-timeouts
            template: configure-dns-timeouts
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

    # Configure kernel panic settings
    - name: configure-kernel-panic
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      container:
        image: ubuntu:questing-20251007
        securityContext:
          privileged: true
        volumeMounts:
          - name: host-root
            mountPath: /host
        command: [/bin/bash, -c]
        args:
          - |
            set -e
            echo "=== Configuring kernel panic on: {{inputs.parameters.node}} ==="

            chroot /host /bin/bash -c '
            set -e
            SYSCTL_FILE="/etc/sysctl.d/99-k8s-panic.conf"

            if [ -f "$SYSCTL_FILE" ]; then
              if grep -q "^kernel.panic = 10" "$SYSCTL_FILE" && \
                 grep -q "^kernel.panic_on_oops = 1" "$SYSCTL_FILE"; then
                CURRENT_PANIC=$(sysctl -n kernel.panic)
                CURRENT_PANIC_ON_OOPS=$(sysctl -n kernel.panic_on_oops)
                if [ "$CURRENT_PANIC" = "10" ] && [ "$CURRENT_PANIC_ON_OOPS" = "1" ]; then
                  echo "Kernel panic already configured, skipping"
                  exit 0
                fi
              fi
            fi

            cat > "$SYSCTL_FILE" <<EOF
            kernel.panic = 10
            kernel.panic_on_oops = 1
            vm.panic_on_oom = 0
            kernel.hung_task_panic = 0
            EOF

            sysctl --system
            echo "✓ Kernel panic configured"
            '

      volumes:
        - name: host-root
          hostPath:
            path: /

    # Configure filesystem optimization
    - name: configure-filesystem
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      container:
        image: ubuntu:questing-20251007
        securityContext:
          privileged: true
        volumeMounts:
          - name: host-root
            mountPath: /host
        command: [/bin/bash, -c]
        args:
          - |
            set -e
            echo "=== Optimizing filesystem on: {{inputs.parameters.node}} ==="

            chroot /host /bin/bash -c '
            set -e
            SYSCTL_FILE="/etc/sysctl.d/99-k8s-filesystem.conf"

            if [ -f "$SYSCTL_FILE" ]; then
              if grep -q "^vm.swappiness = 1" "$SYSCTL_FILE" && \
                 grep -q "^vm.dirty_ratio = 10" "$SYSCTL_FILE" && \
                 grep -q "^fs.inotify.max_user_watches = 524288" "$SYSCTL_FILE"; then
                CURRENT_SWAPPINESS=$(sysctl -n vm.swappiness)
                CURRENT_DIRTY=$(sysctl -n vm.dirty_ratio)
                CURRENT_WATCHES=$(sysctl -n fs.inotify.max_user_watches)
                if [ "$CURRENT_SWAPPINESS" = "1" ] && [ "$CURRENT_DIRTY" = "10" ] && [ "$CURRENT_WATCHES" = "524288" ]; then
                  echo "Filesystem already optimized, skipping"
                  exit 0
                fi
              fi
            fi

            cat > "$SYSCTL_FILE" <<EOF
            vm.swappiness = 1
            vm.dirty_background_ratio = 5
            vm.dirty_ratio = 10
            vm.dirty_expire_centisecs = 1500
            vm.dirty_writeback_centisecs = 500
            fs.file-max = 2097152
            fs.inotify.max_user_watches = 524288
            fs.inotify.max_user_instances = 512
            fs.inotify.max_queued_events = 65536
            fs.aio-max-nr = 1048576
            vm.panic_on_oom = 0
            vm.overcommit_memory = 0
            EOF

            sysctl --system
            echo "✓ Filesystem optimized"
            '

      volumes:
        - name: host-root
          hostPath:
            path: /

    # Configure watchdog
    - name: configure-watchdog
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      container:
        image: ubuntu:questing-20251007
        securityContext:
          privileged: true
        volumeMounts:
          - name: host-root
            mountPath: /host
        command: [/bin/bash, -c]
        args:
          - |
            set -e
            echo "=== Setting up watchdog on: {{inputs.parameters.node}} ==="

            chroot /host /bin/bash -c '
            set -e

            if grep -q "^watchdog-device = /dev/watchdog" /etc/watchdog.conf 2>/dev/null && \
               grep -q "^watchdog-timeout = 120" /etc/watchdog.conf 2>/dev/null && \
               ! grep -q "^max-load" /etc/watchdog.conf 2>/dev/null; then
              echo "Watchdog already configured with heartbeat-only mode, skipping"
              exit 0
            fi

            if ! command -v watchdog >/dev/null 2>&1; then
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install --yes watchdog
            fi

            {
              echo "# Minimal watchdog configuration - heartbeat only"
              echo "watchdog-device = /dev/watchdog"
              echo "watchdog-timeout = 120"
              echo "interval = 30"
              echo "realtime = yes"
              echo "priority = 1"
            } > /etc/watchdog.conf

            nsenter --target 1 --mount --uts --ipc --net --pid -- /usr/bin/systemctl enable watchdog
            nsenter --target 1 --mount --uts --ipc --net --pid -- /usr/bin/systemctl restart watchdog

            if nsenter --target 1 --mount --uts --ipc --net --pid -- systemctl is-active --quiet watchdog; then
              echo "✓ Watchdog configured"
            else
              echo "ERROR: Watchdog failed to start"
              exit 1
            fi
            '

      volumes:
        - name: host-root
          hostPath:
            path: /

    # Configure DNS fallback servers
    - name: configure-dns-fallback
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      container:
        image: ubuntu:questing-20251007
        securityContext:
          privileged: true
        volumeMounts:
          - name: host-root
            mountPath: /host
        command: [/bin/bash, -c]
        args:
          - |
            set -e
            echo "=== Configuring DNS fallback on: {{inputs.parameters.node}} ==="

            chroot /host /bin/bash -c '
            set -e
            CONF_DIR="/etc/systemd/resolved.conf.d"
            CONF_FILE="$CONF_DIR/fallback.conf"

            if [ -f "$CONF_FILE" ]; then
              if grep -q "^DNS=172.16.0.1" "$CONF_FILE" && \
                 grep -q "^FallbackDNS=8.8.8.8 1.1.1.1" "$CONF_FILE"; then
                echo "DNS fallback already configured, skipping"
                exit 0
              fi
            fi

            mkdir -p "$CONF_DIR"

            cat > "$CONF_FILE" <<EOF
            [Resolve]
            DNS=172.16.0.1
            FallbackDNS=8.8.8.8 1.1.1.1
            EOF

            nsenter --target 1 --mount --uts --ipc --net --pid -- /usr/bin/systemctl restart systemd-resolved

            echo "✓ DNS fallback configured"
            '

      volumes:
        - name: host-root
          hostPath:
            path: /

    # Configure DNS timeouts
    - name: configure-dns-timeouts
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      container:
        image: ubuntu:questing-20251007
        securityContext:
          privileged: true
        volumeMounts:
          - name: host-root
            mountPath: /host
        command: [/bin/bash, -c]
        args:
          - |
            set -e
            echo "=== Configuring DNS timeouts on: {{inputs.parameters.node}} ==="

            chroot /host /bin/bash -c '
            set -e
            CONF_DIR="/etc/systemd/resolved.conf.d"
            CONF_FILE="$CONF_DIR/timeouts.conf"

            if [ -f "$CONF_FILE" ]; then
              if grep -q "^DNSStubListenerExtra=127.0.0.54" "$CONF_FILE" && \
                 grep -q "^Cache=yes" "$CONF_FILE" && \
                 grep -q "^StaleRetentionSec=3600" "$CONF_FILE"; then
                echo "DNS timeouts already configured, skipping"
                exit 0
              fi
            fi

            mkdir -p "$CONF_DIR"

            cat > "$CONF_FILE" <<EOF
            [Resolve]
            DNSStubListenerExtra=127.0.0.54
            Cache=yes
            CacheFromLocalhost=no
            DNSOverTLS=no
            MulticastDNS=no
            LLMNR=no
            ReadEtcHosts=yes
            ResolveUnicastSingleLabel=no
            StaleRetentionSec=3600
            EOF

            nsenter --target 1 --mount --uts --ipc --net --pid -- /usr/bin/systemctl restart systemd-resolved

            echo "✓ DNS timeouts configured"
            '

      volumes:
        - name: host-root
          hostPath:
            path: /
