apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: node-upgrade
  namespace: argo
spec:
  serviceAccountName: argo-workflow

  arguments:
    parameters:
      - name: node-role
        value: ""  # empty = all nodes, or specify "control-plane" / "worker"

      - name: upgrade-script
        value: |
          #!/bin/bash
          set -e

          echo "Starting system upgrade on $(hostname)"

          # Update package lists
          apt-get update

          # Perform upgrade with automatic yes to prompts
          DEBIAN_FRONTEND=noninteractive apt-get upgrade --yes \
            --option Dpkg::Options::="--force-confdef" \
            --option Dpkg::Options::="--force-confold"

          # Clean up unnecessary packages
          apt-get autoremove --yes
          apt-get autoclean

          # Check if reboot is required
          if [ -f /var/run/reboot-required ]; then
            echo "Reboot required after upgrade"
            sync
            # Reboot via nsenter to host PID namespace
            nsenter --target 1 --mount --uts --ipc --net --pid -- reboot
          else
            echo "Upgrade completed successfully, no reboot required"
          fi

  entrypoint: main

  templates:
    - name: main
      steps:
        # Get list of nodes matching the role
        - - name: get-nodes
            template: list-nodes

        # Process each node sequentially or with limited parallelism
        - - name: upgrade-node
            template: upgrade-single-node
            arguments:
              parameters:
                - name: node
                  value: "{{item}}"
            withParam: "{{steps.get-nodes.outputs.result}}"
            # Limit parallelism - default is 1 (sequential upgrades)
            parallelism: 1

    # Get list of nodes with specific role (or all nodes if role is empty)
    - name: list-nodes
      script:
        image: rancher/kubectl:v1.31.3
        command: [bash]
        source: |
          if [ -z "{{workflow.parameters.node-role}}" ]; then
            # Get all nodes
            kubectl get nodes \
              -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
              jq -R . | jq -s .
          else
            # Get nodes with specific role
            kubectl get nodes \
              -l node-role.kubernetes.io/{{workflow.parameters.node-role}}=true \
              -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
              jq -R . | jq -s .
          fi

    # Upgrade a single node
    - name: upgrade-single-node
      inputs:
        parameters:
          - name: node

      steps:
        # Run upgrade script on the node
        - - name: run-upgrade
            template: privileged-pod
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

        # Wait for node to come back after potential reboot
        - - name: wait-ready
            template: wait-node-ready
            arguments:
              parameters:
                - name: node
                  value: "{{inputs.parameters.node}}"

    # Privileged pod that runs on specific node
    - name: privileged-pod
      inputs:
        parameters:
          - name: node

      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node}}"

      tolerations:
        - operator: Exists  # tolerate all taints

      container:
        image: ubuntu:noble
        securityContext:
          privileged: true

        volumeMounts:
          - name: host-root
            mountPath: /host

        command: [/bin/bash, -c]
        args:
          - |
            set -e

            echo "==================================="
            echo "Upgrading node: {{inputs.parameters.node}}"
            echo "==================================="

            # Write upgrade script to host
            cat > /host/tmp/upgrade.sh <<'SCRIPT_EOF'
            {{workflow.parameters.upgrade-script}}
            SCRIPT_EOF

            chmod +x /host/tmp/upgrade.sh

            # Execute upgrade script via chroot
            chroot /host /tmp/upgrade.sh

            # Cleanup
            rm -f /host/tmp/upgrade.sh

            echo "Upgrade script completed"

      volumes:
        - name: host-root
          hostPath:
            path: /

    # Wait for node to be ready after reboot
    - name: wait-node-ready
      inputs:
        parameters:
          - name: node

      script:
        image: rancher/kubectl:v1.31.3
        command: [bash]
        source: |
          echo "Waiting for node {{inputs.parameters.node}} to be ready..."

          # Wait up to 10 minutes
          for i in {1..120}; do
            status=$(kubectl get node {{inputs.parameters.node}} \
              -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "NotFound")

            if [ "$status" = "True" ]; then
              echo "✓ Node is ready!"
              exit 0
            fi

            echo "⏳ Attempt $i/120: Node status = $status (waiting 5s)"
            sleep 5
          done

          echo "✗ Timeout waiting for node to be ready"
          exit 1
