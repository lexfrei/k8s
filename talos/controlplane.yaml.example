# Talos Control Plane Configuration - 3x CP HA Setup
# All 3 nodes are control plane, workloads scheduled on all
#
# Generate secrets once:
#   talosctl gen secrets --output-file secrets.yaml
#
# Generate configs:
#   talosctl gen config homelab https://172.16.101.100:6443 \
#     --with-secrets secrets.yaml \
#     --config-patch @patches/common.yaml \
#     --config-patch-control-plane @patches/controlplane.yaml \
#     --output-dir .
#
# Apply per-node patches:
#   talosctl machineconfig patch controlplane.yaml --patch @patches/node-01.yaml --output cp-01.yaml
#   talosctl machineconfig patch controlplane.yaml --patch @patches/node-02.yaml --output cp-02.yaml
#   talosctl machineconfig patch controlplane.yaml --patch @patches/node-03.yaml --output cp-03.yaml

machine:
  type: controlplane

  network:
    hostname: k8s-cp-01  # Override per node
    interfaces:
      - interface: eth0
        addresses:
          - 172.16.101.1/24  # Override per node
        routes:
          - network: 0.0.0.0/0
            gateway: 172.16.101.254
        # Talos native VIP - no vipalived needed!
        vip:
          ip: 172.16.101.100  # Shared VIP for API
    nameservers:
      - 1.1.1.1
      - 8.8.8.8

  time:
    servers:
      - time.cloudflare.com

  kubelet:
    extraArgs:
      rotate-server-certificates: "true"
    nodeIP:
      validSubnets:
        - 172.16.101.0/24

  kernel:
    modules:
      - name: br_netfilter
      - name: xt_socket

  sysctls:
    # Cilium/BPF requirements
    net.core.bpf_jit_enable: "1"
    net.ipv4.ip_forward: "1"
    net.ipv6.conf.all.forwarding: "1"
    net.bridge.bridge-nf-call-iptables: "1"
    net.bridge.bridge-nf-call-ip6tables: "1"
    kernel.unprivileged_bpf_disabled: "1"
    net.core.netdev_max_backlog: "5000"

    # Filesystem (from Ansible sysctl-filesystem.yml)
    fs.file-max: "2097152"
    fs.inotify.max_user_watches: "524288"
    fs.inotify.max_user_instances: "512"
    fs.inotify.max_queued_events: "65536"
    fs.aio-max-nr: "1048576"

    # Memory management (from Ansible)
    vm.swappiness: "1"
    vm.dirty_background_ratio: "5"
    vm.dirty_ratio: "10"
    vm.dirty_expire_centisecs: "1500"
    vm.dirty_writeback_centisecs: "500"
    vm.overcommit_memory: "0"

    # Kernel panic
    kernel.panic: "10"
    kernel.panic_on_oops: "1"

  features:
    rbac: true
    stableHostname: true
    kubePrism:
      enabled: true
      port: 7445

  install:
    disk: /dev/mmcblk0
    image: ghcr.io/siderolabs/installer:v1.9.0
    extensions:
      # iSCSI for Longhorn (replaces open-iscsi package from Ansible)
      - image: ghcr.io/siderolabs/iscsi-tools:v1.9.0

cluster:
  clusterName: homelab

  # VIP endpoint - all 3 nodes share this
  controlPlane:
    endpoint: https://172.16.101.100:6443

  network:
    cni:
      name: none
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
    dnsDomain: k8s.home.lex.la

  proxy:
    disabled: true

  apiServer:
    certSANs:
      - 172.16.101.100  # VIP
      - 172.16.101.1
      - 172.16.101.2
      - 172.16.101.3
      - k8s-cp-01
      - k8s-cp-02
      - k8s-cp-03
      - api.k8s.home.lex.la
    extraArgs: {}

  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0

  scheduler:
    extraArgs:
      bind-address: 0.0.0.0

  etcd:
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
      quota-backend-bytes: "536870912"
      auto-compaction-mode: periodic
      auto-compaction-retention: "1h"
      snapshot-count: "5000"

  coreDNS:
    disabled: false

  adminKubeconfig:
    certLifetime: 8760h

  # All nodes are CP, schedule workloads everywhere
  allowSchedulingOnControlPlanes: true
