global:
  domain: argocd.home.lex.la
configs:
  params:
    server.insecure: true
  cm:
    accounts.admin: apiKey, login
    url: https://argocd.home.lex.la
    # Using Dex for OIDC - Authelia includes all claims in ID token via claims_policy
    dex.config: |
      connectors:
        - type: oidc
          id: authelia
          name: Authelia
          config:
            issuer: https://authelia.home.lex.la
            clientID: argocd
            clientSecret: $dex.authelia.clientSecret
            scopes:
              - openid
              - profile
              - email
              - groups
            userNameKey: preferred_username
            insecureSkipEmailVerified: true
    application.resourceTrackingMethod: annotation
  rbac:
    policy.csv: |
      g, admins, role:admin
  secret:
    extra:
      dex.authelia.clientSecret: c6d255b2b92e2fec47c1b56dea8ab2bff77a7a7c7f46ef3c99859779c7932afd
    resource.compareoptions: |
      ignoreAggregatedRoles: true
    resource.exclusions: |
      - apiGroups:
        - "*"
        kinds:
        - ProviderConfigUsage
    resource.customizations: |
      "*.upbound.io/*":
        health.lua: |
          health_status = {
            status = "Progressing",
            message = "Provisioning ..."
          }

          local function contains (table, val)
            for i, v in ipairs(table) do
              if v == val then
                return true
              end
            end
            return false
          end

          local has_no_status = {
            "ProviderConfig",
            "ProviderConfigUsage"
          }

          if obj.status == nil or next(obj.status) == nil and contains(has_no_status, obj.kind) then
            health_status.status = "Healthy"
            health_status.message = "Resource is up-to-date."
            return health_status
          end

          if obj.status == nil or next(obj.status) == nil or obj.status.conditions == nil then
            if obj.kind == "ProviderConfig" and obj.status.users ~= nil then
              health_status.status = "Healthy"
              health_status.message = "Resource is in use."
              return health_status
            end
            return health_status
          end

          for i, condition in ipairs(obj.status.conditions) do
            if condition.type == "LastAsyncOperation" then
              if condition.status == "False" then
                health_status.status = "Degraded"
                health_status.message = condition.message
                return health_status
              end
            end

            if condition.type == "Synced" then
              if condition.status == "False" then
                health_status.status = "Degraded"
                health_status.message = condition.message
                return health_status
              end
            end

            if condition.type == "Ready" then
              if condition.status == "True" then
                health_status.status = "Healthy"
                health_status.message = "Resource is up-to-date."
                return health_status
              end
            end
          end

          return health_status

      "*.crossplane.io/*":
        health.lua: |
          health_status = {
            status = "Progressing",
            message = "Provisioning ..."
          }

          local function contains (table, val)
            for i, v in ipairs(table) do
              if v == val then
                return true
              end
            end
            return false
          end

          local has_no_status = {
            "Composition",
            "CompositionRevision",
            "DeploymentRuntimeConfig",
            "ControllerConfig",
            "ProviderConfig",
            "ProviderConfigUsage"
          }
          if obj.status == nil or next(obj.status) == nil and contains(has_no_status, obj.kind) then
              health_status.status = "Healthy"
              health_status.message = "Resource is up-to-date."
            return health_status
          end

          if obj.status == nil or next(obj.status) == nil or obj.status.conditions == nil then
            if obj.kind == "ProviderConfig" and obj.status.users ~= nil then
              health_status.status = "Healthy"
              health_status.message = "Resource is in use."
              return health_status
            end
            return health_status
          end

          for i, condition in ipairs(obj.status.conditions) do
            if condition.type == "LastAsyncOperation" then
              if condition.status == "False" then
                health_status.status = "Degraded"
                health_status.message = condition.message
                return health_status
              end
            end

            if condition.type == "Synced" then
              if condition.status == "False" then
                health_status.status = "Degraded"
                health_status.message = condition.message
                return health_status
              end
            end

            if contains({"Ready", "Healthy", "Offered", "Established"}, condition.type) then
              if condition.status == "True" then
                health_status.status = "Healthy"
                health_status.message = "Resource is up-to-date."
                return health_status
              end
            end
          end

          return health_status
repoServer:
  replicas: 2
  pdb:
    enabled: true
    minAvailable: 1
server:
  replicas: 2
  pdb:
    enabled: true
    minAvailable: 1
  service:
    type: LoadBalancer
    annotations:
      io.cilium/lb-ipam-ips: "172.16.100.254"
      external-dns.alpha.kubernetes.io/hostname: "api.argocd.home.lex.la"
  ingress:
    enabled: false
  httproute:
    enabled: true
    annotations: {}
    parentRefs:
      - name: cilium-gateway-internal
        namespace: kube-system
        sectionName: https-home-lex-la
    hostnames:
      - argocd.home.lex.la
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: /
  # extensions:
  #   enabled: true
  #   extensionList:
  #     - name: extension-trivy
  #       env:
  #         - name: EXTENSION_URL
  #           value: https://github.com/lexfrei/argocd-trivy-extension/releases/download/v0.2.0/extension-trivy.tar
  #         - name: EXTENSION_CHECKSUM_URL
  #           value: https://github.com/lexfrei/argocd-trivy-extension/releases/download/v0.2.0/extension-trivy_checksums.txt
