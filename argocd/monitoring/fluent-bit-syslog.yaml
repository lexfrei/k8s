apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fluent-bit-syslog
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: monitoring
  destination:
    namespace: monitoring
    server: "https://kubernetes.default.svc"
  sources:
    - repoURL: "https://fluent.github.io/helm-charts"
      targetRevision: "0.56.0"
      chart: fluent-bit
      helm:
        valuesObject:
          kind: Deployment
          replicaCount: 1

          service:
            type: LoadBalancer
            annotations:
              io.cilium/lb-ipam-ips: "172.16.100.249"

          extraPorts:
            - port: 5140
              containerPort: 5140
              protocol: UDP
              name: syslog
            - port: 5141
              containerPort: 5141
              protocol: UDP
              name: syslog-truenas

          config:
            service: |
              [SERVICE]
                  Daemon Off
                  Flush 1
                  Log_Level info
                  Parsers_File /fluent-bit/etc/parsers.conf
                  Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
                  HTTP_Server On
                  HTTP_Listen 0.0.0.0
                  HTTP_Port 2020
                  Health_Check On

            customParsers: |
              [PARSER]
                  Name        syslog-rfc5424-nofrac
                  Format      regex
                  Regex       ^\<(?<pri>[0-9]{1,5})>1 (?<time>[^ ]+) (?<host>[^ ]+) (?<ident>[^ ]+) (?<pid>[-0-9]+) (?<msgid>[^ ]+) (?<extradata>(\[(.*?)\]|-)+) (?<message>.+)$
                  Time_Key    time
                  Time_Format %Y-%m-%dT%H:%M:%S%z
                  Time_Keep   On

            inputs: |
              [INPUT]
                  Name syslog
                  Mode udp
                  Listen 0.0.0.0
                  Port 5140
                  Parser syslog-rfc5424-nofrac
                  Tag ilo

              [INPUT]
                  Name syslog
                  Mode udp
                  Listen 0.0.0.0
                  Port 5141
                  Parser syslog-rfc5424-nofrac
                  Tag truenas

            filters: |
              [FILTER]
                  Name grep
                  Match ilo
                  Exclude message IPMI/RMCP (login|logout) by exporter

              [FILTER]
                  Name modify
                  Match ilo
                  Add job ilo-syslog

              [FILTER]
                  Name modify
                  Match truenas
                  Add job truenas-syslog

            outputs: |
              [OUTPUT]
                  Name loki
                  Match ilo
                  host loki.monitoring.svc
                  port 3100
                  labels job=ilo-syslog
                  line_format json
                  auto_kubernetes_labels off

              [OUTPUT]
                  Name loki
                  Match truenas
                  host loki.monitoring.svc
                  port 3100
                  labels job=truenas-syslog
                  line_format json
                  auto_kubernetes_labels off

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
