apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: internal-dns
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: infra
  destination:
    namespace: internal-dns
    server: "https://kubernetes.default.svc"
  sources:
    - repoURL: "https://kubernetes-sigs.github.io/external-dns/"
      targetRevision: "1.20.0"
      chart: external-dns
      helm:
        valuesObject:
          provider:
            name: webhook
            webhook:
              image:
                repository: ghcr.io/lexfrei/external-dns-unifios-webhook
                tag: "0.2.0"
              env:
                - name: WEBHOOK_UNIFI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: unifi-api-key
                      key: api-key
                - name: WEBHOOK_UNIFI_HOST
                  value: "https://172.16.0.1"
                - name: WEBHOOK_DEBUG_PPROF_ENABLED
                  value: "true"
              livenessProbe:
                httpGet:
                  path: /healthz
                  port: 8080
                initialDelaySeconds: 10
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /readyz
                  port: 8080
                initialDelaySeconds: 10
                periodSeconds: 10
          policy: sync
          sources:
            - gateway-httproute
            - service
          txtOwnerId: unifi
          extraArgs:
            - --annotation-prefix=internal-dns/
            - --annotation-filter=internal-dns/target
          logLevel: info
          logFormat: json
    - path: manifests/internal-dns
      repoURL: https://github.com/lexfrei/k8s.git
      targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
