apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: authelia
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: security
  destination:
    namespace: security
    server: "https://kubernetes.default.svc"
  sources:
    - repoURL: "https://charts.authelia.com"
      targetRevision: "0.10.49"
      chart: authelia
      helm:
        valuesObject:
          pod:
            kind: Deployment
            replicas: 1
            strategy:
              type: Recreate
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 256Mi
            extraVolumeMounts:
              - name: users-config
                mountPath: /config/users_database.yml
                subPath: users_database.yml
                readOnly: true
            extraVolumes:
              - name: users-config
                configMap:
                  name: authelia-users

          secret:
            additionalSecrets:
              authelia-secrets: {}

          persistence:
            enabled: true
            storageClass: longhorn
            size: 1Gi

          configMap:
            theme: auto
            default_2fa_method: webauthn

            log:
              level: info

            totp:
              disable: true

            webauthn:
              disable: false
              enable_passkey_login: true
              display_name: home.lex.la
              timeout: 60 seconds

            duo_api:
              enabled: false

            authentication_backend:
              password_reset:
                disable: true
              file:
                enabled: true
                path: /config/users_database.yml
                password:
                  algorithm: argon2

            session:
              name: authelia_session
              same_site: lax
              inactivity: 5m
              expiration: 1h
              remember_me: 1M
              encryption_key:
                secret_name: authelia-secrets
                path: SESSION_SECRET
              cookies:
                - domain: home.lex.la
                  authelia_url: https://authelia.home.lex.la
                  default_redirection_url: https://grafana.home.lex.la

            regulation:
              max_retries: 3
              find_time: 2m
              ban_time: 5m

            storage:
              encryption_key:
                secret_name: authelia-secrets
                path: STORAGE_ENCRYPTION_KEY
              local:
                enabled: true
                path: /config/db.sqlite3

            notifier:
              disable_startup_check: true
              filesystem:
                enabled: true
                filename: /config/notification.txt

            access_control:
              default_policy: two_factor
              rules:
                - domain: "*.home.lex.la"
                  policy: one_factor
                  resources:
                    - "^/api([/?].*)?$"
                - domain: "*.home.lex.la"
                  policy: two_factor

            identity_validation:
              reset_password:
                secret:
                  secret_name: authelia-secrets
                  path: JWT_SECRET

            identity_providers:
              oidc:
                enabled: true
                hmac_secret:
                  secret_name: authelia-secrets
                  path: OIDC_HMAC_SECRET
                jwks:
                  - key:
                      path: /secrets/authelia-secrets/OIDC_PRIVATE_KEY
                clients:
                  - client_id: grafana
                    client_name: Grafana
                    client_secret:
                      path: /secrets/authelia-secrets/GRAFANA_CLIENT_SECRET
                    authorization_policy: two_factor
                    redirect_uris:
                      - https://grafana.home.lex.la/login/generic_oauth
                    scopes:
                      - openid
                      - profile
                      - email
                      - groups
                  - client_id: argocd
                    client_name: ArgoCD
                    client_secret:
                      path: /secrets/authelia-secrets/ARGOCD_CLIENT_SECRET
                    authorization_policy: two_factor
                    redirect_uris:
                      - https://argocd.home.lex.la/auth/callback
                    scopes:
                      - openid
                      - profile
                      - email
                      - groups
                    # Include groups claim in ID token (not just userinfo)
                    id_token_signed_response_alg: RS256
                    userinfo_signed_response_alg: none
                  - client_id: openbao
                    client_name: OpenBao
                    client_secret:
                      path: /secrets/authelia-secrets/OPENBAO_CLIENT_SECRET
                    authorization_policy: two_factor
                    redirect_uris:
                      - https://openbao.home.lex.la/ui/vault/auth/oidc/oidc/callback
                      - http://localhost:8250/oidc/callback
                    scopes:
                      - openid
                      - profile
                      - email
                      - groups

    - repoURL: https://github.com/lexfrei/k8s.git
      targetRevision: HEAD
      path: manifests/authelia
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
