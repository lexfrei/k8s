apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: papermc
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: workloads
  destination:
    namespace: paper
    server: "https://kubernetes.default.svc"
  sources:
    - chart: papermc
      repoURL: ghcr.io/lexfrei
      targetRevision: 0.2.0
      helm:
        values: |
          fullnameOverride: "papermc"

          podLabels:
            app: papermc
            type: paper

          image:
            repository: lexfrei/papermc
            pullPolicy: Always

          ports:
            minecraft:
              tcp: 25565
              udp: 25565
            extra:
              - name: bluemap
                port: 8100
                protocol: TCP

          service:
            type: LoadBalancer
            externalTrafficPolicy: Local
            annotations:
              io.cilium/lb-ipam-ips: "172.16.100.253"

          httpRoute:
            enabled: true
            spec:
              parentRefs:
                - name: cloudflare-tunnel
                  namespace: cloudflare-tunnel-system
              hostnames:
                - map.lex.la
              rules:
                - matches:
                    - path:
                        type: PathPrefix
                        value: /
                  backendRefs:
                    - name: papermc
                      port: 8100

          persistence:
            enabled: true
            storageClassName: longhorn
            size: 40Gi

          resources:
            requests:
              memory: "6Gi"
              cpu: "3000m"
            limits:
              memory: "6Gi"
              cpu: "4000m"

          tolerations:
            - key: minecraft
              operator: Equal
              value: "true"
              effect: NoExecute

          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: minecraft
                        operator: In
                        values:
                          - "true"

          livenessProbe:
            enabled: true
            tcpSocket:
              port: minecraft-tcp
            initialDelaySeconds: 60
            periodSeconds: 15

          readinessProbe:
            enabled: true
            tcpSocket:
              port: minecraft-tcp
            initialDelaySeconds: 30
            periodSeconds: 10

          updateStrategy:
            type: RollingUpdate
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
