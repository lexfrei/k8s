name: ArgoCD Diff

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  diff:
    runs-on: homelab
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install ArgoCD CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=$(curl --silent --header "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/argoproj/argo-cd/releases/latest" \
            | grep '"tag_name"' | sed 's/.*"\(.*\)".*/\1/')

          if [ -z "${LATEST}" ]; then
            echo "Failed to get latest ArgoCD version"
            exit 1
          fi

          echo "Installing ArgoCD CLI ${LATEST}"
          curl --location --fail --output /tmp/argocd \
            --header "Authorization: Bearer ${GH_TOKEN}" \
            "https://github.com/argoproj/argo-cd/releases/download/${LATEST}/argocd-linux-arm64"
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: Find affected ArgoCD apps
        id: affected
        run: |
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD)

          if [ -z "${CHANGED_FILES}" ]; then
            echo "apps=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          AFFECTED_APPS=""

          for file in ${CHANGED_FILES}; do
            case "${file}" in
              # Direct ArgoCD app definition changes (skip project.yaml files)
              argocd/*/[!p]*.yaml)
                APP_NAME=$(grep '^  name:' "${file}" 2>/dev/null | head -1 | awk '{print $2}')
                if [ -n "${APP_NAME}" ]; then
                  AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                fi
                ;;

              # Manifest directory changes
              manifests/*/*)
                MANIFEST_DIR=$(echo "${file}" | cut --delimiter='/' --fields=1-2)
                for app_file in argocd/*/*.yaml; do
                  if grep --quiet "path: ${MANIFEST_DIR}" "${app_file}" 2>/dev/null; then
                    APP_NAME=$(grep '^  name:' "${app_file}" 2>/dev/null | head -1 | awk '{print $2}')
                    if [ -n "${APP_NAME}" ]; then
                      AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                    fi
                  fi
                done
                ;;

              # Values file changes
              values/*.yaml)
                VALUES_REF="\$values/${file}"
                for app_file in argocd/*/*.yaml; do
                  if grep --quiet "${VALUES_REF}" "${app_file}" 2>/dev/null; then
                    APP_NAME=$(grep '^  name:' "${app_file}" 2>/dev/null | head -1 | awk '{print $2}')
                    if [ -n "${APP_NAME}" ]; then
                      AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                    fi
                  fi
                done
                ;;
            esac
          done

          # Deduplicate
          AFFECTED_APPS=$(echo "${AFFECTED_APPS}" | tr ' ' '\n' | sort --unique | tr '\n' ' ' | xargs)

          echo "apps=${AFFECTED_APPS}" >> "${GITHUB_OUTPUT}"
          echo "Affected apps: ${AFFECTED_APPS}"

      - name: Run ArgoCD diff
        if: steps.affected.outputs.apps != ''
        id: diff
        env:
          SHA: ${{ github.event.pull_request.head.sha }}
          GIT_REPO: https://github.com/lexfrei/k8s.git
        run: |
          {
            echo "## ArgoCD Diff"
            echo ""
            echo 'Affected applications: `'"${{ steps.affected.outputs.apps }}"'`'
            echo ""
          } > /tmp/diff-comment.md

          HAS_DIFF="false"

          # Create kubeconfig with argocd namespace so --core finds argocd-cm
          SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          SA_CA=$(base64 --wrap=0 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)
          printf '{"apiVersion":"v1","kind":"Config","clusters":[{"cluster":{"certificate-authority-data":"%s","server":"https://kubernetes.default.svc"},"name":"c"}],"contexts":[{"context":{"cluster":"c","namespace":"argocd","user":"u"},"name":"ctx"}],"current-context":"ctx","users":[{"name":"u","user":{"token":"%s"}}]}' "${SA_CA}" "${SA_TOKEN}" > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig

          for app in ${{ steps.affected.outputs.apps }}; do
            echo "--- Diffing app: ${app} ---"

            echo "### ${app}" >> /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md

            # Check if app exists in cluster (new apps can't be diffed)
            if ! argocd app get "argocd/${app}" --core >/dev/null 2>&1; then
              echo "> New application â€” not yet deployed to the cluster." >> /tmp/diff-comment.md
              echo "" >> /tmp/diff-comment.md
              continue
            fi

            # Find app definition file
            APP_FILE=$(grep -rl "^  name: ${app}$" argocd/ 2>/dev/null | grep -v project.yaml | head -1)

            # Build diff flags: multi-source apps need --source-positions/--revisions
            DIFF_FLAGS="--revision ${SHA}"
            if [ -n "${APP_FILE}" ] && grep -q "^  sources:" "${APP_FILE}"; then
              export APP_FILE
              MULTI_FLAGS=$(python3 << 'PYEOF'
import os
app_file = os.environ["APP_FILE"]
git_repo = os.environ["GIT_REPO"]
sha = os.environ["SHA"]
positions = []
pos = 0
in_sources = False
with open(app_file) as f:
    for line in f:
        s = line.strip()
        if line.rstrip() == "  sources:":
            in_sources = True
            continue
        if in_sources and not line.startswith("    ") and s:
            break
        if in_sources and s.startswith("- repoURL:"):
            pos += 1
            if git_repo in s:
                positions.append(str(pos))
if positions:
    p = ",".join(positions)
    r = ",".join([sha] * len(positions))
    print(f"--source-positions {p} --revisions {r}")
PYEOF
              )
              if [ -n "${MULTI_FLAGS}" ]; then
                DIFF_FLAGS="${MULTI_FLAGS}"
              fi
            fi

            EXIT_CODE=0
            DIFF_RESULT=$(argocd app diff "argocd/${app}" \
              --core \
              ${DIFF_FLAGS} 2>&1) || EXIT_CODE=$?

            if [ "${EXIT_CODE}" -eq 0 ]; then
              echo "No changes detected." >> /tmp/diff-comment.md
            elif [ "${EXIT_CODE}" -eq 1 ]; then
              HAS_DIFF="true"
              echo '```diff' >> /tmp/diff-comment.md
              echo "${DIFF_RESULT}" >> /tmp/diff-comment.md
              echo '```' >> /tmp/diff-comment.md
            else
              echo "> Could not generate diff (exit code ${EXIT_CODE}): ${DIFF_RESULT}" >> /tmp/diff-comment.md
            fi

            echo "" >> /tmp/diff-comment.md
          done

          echo "has_diff=${HAS_DIFF}" >> "${GITHUB_OUTPUT}"

      - name: Post PR comment
        if: steps.affected.outputs.apps != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ ! -f /tmp/diff-comment.md ]; then
            {
              echo "## ArgoCD Diff"
              echo ""
              echo 'Affected applications: `'"${{ steps.affected.outputs.apps }}"'`'
              echo ""
              echo "> No diff output available."
            } > /tmp/diff-comment.md
          fi

          # Delete previous ArgoCD diff comment if exists
          PREVIOUS_COMMENT_ID=$(curl --silent \
            --header "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            | python3 -c "
          import sys, json
          comments = json.load(sys.stdin)
          for c in comments:
              if '## ArgoCD Diff' in c.get('body', ''):
                  print(c['id'])
                  break
          " 2>/dev/null)

          if [ -n "${PREVIOUS_COMMENT_ID}" ]; then
            curl --silent --request DELETE \
              --header "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/${PREVIOUS_COMMENT_ID}"
          fi

          # Post new comment using python for JSON escaping
          python3 -c "
          import sys, json
          body = open('/tmp/diff-comment.md').read()
          json.dump({'body': body}, sys.stdout)
          " | curl --silent --request POST \
            --header "Authorization: Bearer ${GH_TOKEN}" \
            --header "Content-Type: application/json" \
            --data @- \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
