name: ArgoCD Diff

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  diff:
    runs-on: homelab
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install ArgoCD CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo argoproj/argo-cd --pattern 'argocd-linux-arm64' --output argocd
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Find affected ArgoCD apps
        id: affected
        run: |
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD)

          if [ -z "${CHANGED_FILES}" ]; then
            echo "apps=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          AFFECTED_APPS=""

          for file in ${CHANGED_FILES}; do
            case "${file}" in
              # Direct ArgoCD app definition changes (skip project.yaml files)
              argocd/*/[!p]*.yaml)
                APP_NAME=$(grep '^  name:' "${file}" 2>/dev/null | head -1 | awk '{print $2}')
                if [ -n "${APP_NAME}" ]; then
                  AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                fi
                ;;

              # Manifest directory changes
              manifests/*/*)
                MANIFEST_DIR=$(echo "${file}" | cut --delimiter='/' --fields=1-2)
                for app_file in argocd/*/*.yaml; do
                  if grep --quiet "path: ${MANIFEST_DIR}" "${app_file}" 2>/dev/null; then
                    APP_NAME=$(grep '^  name:' "${app_file}" 2>/dev/null | head -1 | awk '{print $2}')
                    if [ -n "${APP_NAME}" ]; then
                      AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                    fi
                  fi
                done
                ;;

              # Values file changes
              values/*.yaml)
                VALUES_REF="\$values/${file}"
                for app_file in argocd/*/*.yaml; do
                  if grep --quiet "${VALUES_REF}" "${app_file}" 2>/dev/null; then
                    APP_NAME=$(grep '^  name:' "${app_file}" 2>/dev/null | head -1 | awk '{print $2}')
                    if [ -n "${APP_NAME}" ]; then
                      AFFECTED_APPS="${AFFECTED_APPS} ${APP_NAME}"
                    fi
                  fi
                done
                ;;
            esac
          done

          # Deduplicate
          AFFECTED_APPS=$(echo "${AFFECTED_APPS}" | tr ' ' '\n' | sort --unique | tr '\n' ' ' | xargs)

          echo "apps=${AFFECTED_APPS}" >> "${GITHUB_OUTPUT}"
          echo "Affected apps: ${AFFECTED_APPS}"

      - name: Run ArgoCD diff
        if: steps.affected.outputs.apps != ''
        id: diff
        run: |
          {
            echo "## ArgoCD Diff"
            echo ""
            echo 'Affected applications: `'"${{ steps.affected.outputs.apps }}"'`'
            echo ""
          } > /tmp/diff-comment.md

          HAS_DIFF="false"

          for app in ${{ steps.affected.outputs.apps }}; do
            echo "--- Diffing app: ${app} ---"

            DIFF_RESULT=$(argocd app diff "argocd/${app}" \
              --core \
              --hard-refresh 2>&1) || EXIT_CODE=$?
            EXIT_CODE=${EXIT_CODE:-0}

            echo "### ${app}" >> /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md

            if [ "${EXIT_CODE}" -eq 0 ]; then
              echo "No changes detected." >> /tmp/diff-comment.md
            elif [ "${EXIT_CODE}" -eq 1 ]; then
              HAS_DIFF="true"
              echo '```diff' >> /tmp/diff-comment.md
              echo "${DIFF_RESULT}" >> /tmp/diff-comment.md
              echo '```' >> /tmp/diff-comment.md
            else
              echo "> Could not generate diff (exit code ${EXIT_CODE}): ${DIFF_RESULT}" >> /tmp/diff-comment.md
            fi

            echo "" >> /tmp/diff-comment.md
          done

          echo "has_diff=${HAS_DIFF}" >> "${GITHUB_OUTPUT}"

      - name: Post PR comment
        if: steps.affected.outputs.apps != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ ! -f /tmp/diff-comment.md ]; then
            {
              echo "## ArgoCD Diff"
              echo ""
              echo 'Affected applications: `'"${{ steps.affected.outputs.apps }}"'`'
              echo ""
              echo "> No diff output available."
            } > /tmp/diff-comment.md
          fi

          COMMENT_BODY=$(cat /tmp/diff-comment.md)

          # Delete previous ArgoCD diff comment if exists
          PREVIOUS_COMMENT_ID=$(curl --silent \
            --header "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            | grep --before-context=1 '"## ArgoCD Diff"' \
            | grep '"id"' | head -1 | grep --only-matching '[0-9]*')

          if [ -n "${PREVIOUS_COMMENT_ID}" ]; then
            curl --silent --request DELETE \
              --header "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/${PREVIOUS_COMMENT_ID}"
          fi

          curl --silent --request POST \
            --header "Authorization: Bearer ${GH_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$(jq --null-input --arg body "${COMMENT_BODY}" '{"body": $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
