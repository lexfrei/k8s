# System Upgrade Plan: CPU Governor Ondemand Mode
#
# Purpose: Set CPU frequency governor to 'ondemand' mode
#
# What it does:
#   - Installs cpufrequtils package for CPU frequency management
#   - Sets CPU governor to 'ondemand' mode (dynamic frequency scaling)
#   - Configures systemd service to apply on boot
#
# Why ondemand instead of performance:
#   - Performance mode causes excessive fan noise in home environment
#   - Ondemand provides good balance between performance and power/noise
#   - For home cluster, noise reduction is higher priority than maximum performance
#
# Trade-off: Potential for RCU stalls under extreme load, but acceptable for home use
#
# Idempotency: Checks current governor state before making changes
#
---
apiVersion: v1
kind: Secret
metadata:
  name: cpu-governor-secret
  namespace: system-upgrade
type: Opaque
stringData:
  setup.sh: |
    #!/bin/sh
    set -e

    echo "Configuring CPU governor on $(hostname)"

    # Check current governor
    CURRENT_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "unknown")
    echo "Current CPU governor: $CURRENT_GOVERNOR"

    # Check if already set to ondemand
    if [ "$CURRENT_GOVERNOR" = "ondemand" ]; then
      # Verify configuration file exists
      if [ -f /etc/default/cpufrequtils ] && grep -q "GOVERNOR=\"ondemand\"" /etc/default/cpufrequtils; then
        echo "CPU governor already set to ondemand and persistent, skipping"
        exit 0
      fi
    fi

    # Update package lists
    apt-get update

    # Install cpufrequtils
    DEBIAN_FRONTEND=noninteractive apt-get install --yes cpufrequtils

    # Configure ondemand governor
    cat > /etc/default/cpufrequtils <<'EOF'
    # CPU frequency governor configuration
    # Set to ondemand mode for better power/noise balance in home environment
    GOVERNOR="ondemand"
    EOF

    # Apply governor immediately to all CPUs
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
      if [ -f "$cpu/cpufreq/scaling_governor" ]; then
        echo "ondemand" > "$cpu/cpufreq/scaling_governor"
        echo "Set $(basename $cpu) to ondemand mode"
      fi
    done

    # Enable cpufrequtils service
    systemctl enable cpufrequtils 2>/dev/null || true

    # Verify configuration
    FINAL_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    if [ "$FINAL_GOVERNOR" = "ondemand" ]; then
      echo "CPU governor successfully set to ondemand"
    else
      echo "ERROR: Failed to set CPU governor to ondemand (current: $FINAL_GOVERNOR)"
      exit 1
    fi
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: cpu-governor-ondemand
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
  serviceAccountName: system-upgrade
  secrets:
    - name: cpu-governor-secret
      path: /host/run/system-upgrade/secrets
  version: v2.0.0
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky-20251001
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/setup.sh
