# System Upgrade Plan: CPU Governor Performance Mode
#
# Purpose: Set CPU frequency governor to 'performance' mode
#
# What it does:
#   - Installs cpufrequtils package for CPU frequency management
#   - Sets CPU governor to 'performance' mode (maximum frequency)
#   - Configures systemd service to apply on boot
#   - Disables ondemand governor (dynamic frequency scaling)
#
# Why it's needed:
#   - Current 'ondemand' governor causes RCU stalls under load
#   - Performance mode eliminates frequency scaling delays
#   - Critical for Kubernetes node stability and predictable performance
#   - Detected as ondemand in node audit (High priority)
#
# Trade-off: Slightly higher power consumption for better stability
#
# Idempotency: Checks current governor state before making changes
#
---
apiVersion: v1
kind: Secret
metadata:
  name: cpu-governor-secret
  namespace: system-upgrade
type: Opaque
stringData:
  setup.sh: |
    #!/bin/sh
    set -e

    echo "Configuring CPU governor on $(hostname)"

    # Check current governor
    CURRENT_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "unknown")
    echo "Current CPU governor: $CURRENT_GOVERNOR"

    # Check if already set to performance
    if [ "$CURRENT_GOVERNOR" = "performance" ]; then
      # Verify configuration file exists
      if [ -f /etc/default/cpufrequtils ] && grep -q "GOVERNOR=\"performance\"" /etc/default/cpufrequtils; then
        echo "CPU governor already set to performance and persistent, skipping"
        exit 0
      fi
    fi

    # Update package lists
    apt-get update

    # Install cpufrequtils
    DEBIAN_FRONTEND=noninteractive apt-get install --yes cpufrequtils

    # Configure performance governor
    cat > /etc/default/cpufrequtils <<'EOF'
    # CPU frequency governor configuration
    # Set to performance mode for Kubernetes node stability
    GOVERNOR="performance"
    EOF

    # Disable ondemand service if exists
    if systemctl list-unit-files | grep -q ondemand; then
      systemctl disable ondemand 2>/dev/null || true
      systemctl stop ondemand 2>/dev/null || true
    fi

    # Apply governor immediately to all CPUs
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
      if [ -f "$cpu/cpufreq/scaling_governor" ]; then
        echo "performance" > "$cpu/cpufreq/scaling_governor"
        echo "Set $(basename $cpu) to performance mode"
      fi
    done

    # Enable cpufrequtils service
    systemctl enable cpufrequtils 2>/dev/null || true

    # Verify configuration
    FINAL_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    if [ "$FINAL_GOVERNOR" = "performance" ]; then
      echo "CPU governor successfully set to performance"
    else
      echo "ERROR: Failed to set CPU governor to performance (current: $FINAL_GOVERNOR)"
      exit 1
    fi
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: cpu-governor-performance
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
  serviceAccountName: system-upgrade
  secrets:
    - name: cpu-governor-secret
      path: /host/run/system-upgrade/secrets
  version: v1.0.0
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky-20251001
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/setup.sh
