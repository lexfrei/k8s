---
# Enable PCIe Gen 3 (8 GT/s) on Raspberry Pi 5 for NVMe performance
# RPi5 defaults to PCIe Gen 2 (5 GT/s). Gen 3 doubles bandwidth from ~400 to ~800 MB/s.
# This is unofficial but widely used and stable with most NVMe drives.

- name: Enable PCIe Gen 3 on Raspberry Pi 5
  ansible.builtin.blockinfile:
    path: /boot/firmware/config.txt
    marker: "# {mark} PCIe Gen 3 configuration (managed by ansible)"
    block: |
      [pi5]
      dtparam=pciex1_gen=3
  register: pcie_gen3_config
  tags:
    - pcie-gen3

- name: Notify about required reboot for PCIe Gen 3
  ansible.builtin.debug:
    msg: "PCIe Gen 3 config changed on {{ inventory_hostname }}. Reboot required for changes to take effect."
  when: pcie_gen3_config.changed
  tags:
    - pcie-gen3
