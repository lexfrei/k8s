---
# Configure hardware watchdog with three-level protection
# Level 1: Network repair - reload macb module on ping failure
# Level 2: Software reboot - if repair fails
# Level 3: Hardware failsafe - bcm2835_wdt triggers reboot on no heartbeat
# See Error 15 in CLAUDE.md - network death without link down
# NOTE: watchdog package is installed via apt-packages.yml (node_prep_system_packages)

- name: Deploy watchdog network repair script
  ansible.builtin.template:
    src: watchdog-network-repair.sh.j2
    dest: "{{ node_prep_watchdog_repair_binary }}"
    owner: root
    group: root
    mode: '0755'
  notify: restart watchdog
  tags:
    - watchdog
    - scripts

- name: Deploy watchdog configuration
  ansible.builtin.template:
    src: watchdog.conf.j2
    dest: /etc/watchdog.conf
    owner: root
    group: root
    mode: '0644'
    backup: true
  notify: restart watchdog
  tags:
    - watchdog
    - config

- name: Enable watchdog service
  ansible.builtin.systemd:
    name: watchdog
    enabled: true
  tags:
    - watchdog

- name: Start watchdog service
  ansible.builtin.systemd:
    name: watchdog
    state: started
  tags:
    - watchdog

- name: Verify watchdog service is running
  ansible.builtin.systemd:
    name: watchdog
  register: watchdog_status
  failed_when: watchdog_status.status.ActiveState != 'active'
  tags:
    - watchdog
