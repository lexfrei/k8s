---
# Configure hardware watchdog with three-level protection
# Level 1: Network repair - reload macb module on ping failure
# Level 2: Software reboot - if repair fails
# Level 3: Hardware failsafe - bcm2835_wdt triggers reboot on no heartbeat
# See Error 15 in CLAUDE.md - network death without link down
# NOTE: watchdog package is installed via apt-packages.yml (node_prep_system_packages)

- name: Deploy watchdog network repair script
  ansible.builtin.template:
    src: watchdog-network-repair.sh.j2
    dest: "{{ node_prep_watchdog_repair_binary }}"
    owner: root
    group: root
    mode: '0755'
  notify: restart watchdog
  tags:
    - watchdog
    - scripts

- name: Deploy watchdog configuration
  ansible.builtin.template:
    src: watchdog.conf.j2
    dest: /etc/watchdog.conf
    owner: root
    group: root
    mode: '0644'
    backup: true
  notify: restart watchdog
  tags:
    - watchdog
    - config

- name: Disable wd_keepalive (must not feed hw watchdog when daemon crashes)
  ansible.builtin.copy:
    dest: /etc/default/watchdog
    content: |
      # Ansible managed
      # CRITICAL: wd_keepalive must be disabled
      # When watchdog daemon crashes, hw watchdog must trigger reboot
      # wd_keepalive prevents this by continuing heartbeats
      run_wd_keepalive=0
    owner: root
    group: root
    mode: '0644'
  notify: restart watchdog
  tags:
    - watchdog

- name: Stop and disable wd_keepalive service
  ansible.builtin.systemd:
    name: wd_keepalive
    state: stopped
    enabled: false
  failed_when: false
  tags:
    - watchdog

- name: Create watchdog.service override directory
  ansible.builtin.file:
    path: /etc/systemd/system/watchdog.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - watchdog

- name: Configure watchdog service restart policy
  ansible.builtin.copy:
    dest: /etc/systemd/system/watchdog.service.d/restart.conf
    content: |
      # Ansible managed
      # Ensure watchdog daemon restarts on failure
      [Service]
      Restart=on-failure
      RestartSec=5
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart watchdog
  tags:
    - watchdog

- name: Enable watchdog service
  ansible.builtin.systemd:
    name: watchdog
    enabled: true
  tags:
    - watchdog

- name: Start watchdog service
  ansible.builtin.systemd:
    name: watchdog
    state: started
  tags:
    - watchdog

- name: Verify watchdog service is running
  ansible.builtin.systemd:
    name: watchdog
  register: watchdog_status
  failed_when: watchdog_status.status.ActiveState != 'active'
  tags:
    - watchdog
