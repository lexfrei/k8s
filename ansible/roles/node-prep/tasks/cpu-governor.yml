---
# CPU frequency governor configuration
# Sets CPU to performance mode to prevent frequency scaling issues
# that may cause RCU stalls on Raspberry Pi 5 with RP1 southbridge (kernel 6.17+)

- name: Check if cpufreq governor is available
  ansible.builtin.stat:
    path: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
  register: cpufreq_governor_file
  tags:
    - cpu-governor

- name: Configure CPU governor
  when: cpufreq_governor_file.stat.exists
  tags:
    - cpu-governor
  block:
    - name: Get current CPU governor
      ansible.builtin.slurp:
        src: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
      register: current_governor

    - name: Display current governor
      ansible.builtin.debug:
        msg: "Current CPU governor: {{ current_governor.content | b64decode | trim }}"

    - name: Set CPU governor to {{ node_prep_cpu_governor }}
      ansible.builtin.shell: |
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
          echo "{{ node_prep_cpu_governor }}" > "$cpu"
        done
      when: (current_governor.content | b64decode | trim) != node_prep_cpu_governor
      changed_when: true

    - name: Make CPU governor persistent via cpufrequtils
      ansible.builtin.copy:
        dest: /etc/default/cpufrequtils
        content: |
          # CPU frequency governor configuration
          # Set to performance to avoid RCU stalls from frequency scaling
          # See: https://github.com/lexfrei/k8s/issues/526
          GOVERNOR="{{ node_prep_cpu_governor }}"
        owner: root
        group: root
        mode: "0644"
      notify: Restart cpufrequtils

    - name: Ensure cpufrequtils service is enabled
      ansible.builtin.systemd:
        name: cpufrequtils
        enabled: true
        state: started
      ignore_errors: true

    - name: Verify CPU governor applied
      ansible.builtin.slurp:
        src: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
      register: new_governor

    - name: Display new governor
      ansible.builtin.debug:
        msg: "CPU governor now set to: {{ new_governor.content | b64decode | trim }}"

- name: Skip CPU governor configuration (cpufreq not available)
  when: not cpufreq_governor_file.stat.exists
  ansible.builtin.debug:
    msg: "cpufreq governor not available on this system, skipping"
  tags:
    - cpu-governor
