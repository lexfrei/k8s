---
# Node preparation main tasks
# Prepares K3s cluster nodes with required packages and configurations

- name: Node preparation
  tags:
    - node-prep
  block:
    - name: Set system hostname
      ansible.builtin.include_tasks: set-hostname.yml
      tags:
        - hostname

    - name: Update APT cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: "{{ node_prep_apt_cache_valid_time }}"
      tags:
        - packages
        - apt-cache

    - name: Install required packages
      ansible.builtin.include_tasks: apt-packages.yml
      when: node_prep_apt_packages | length > 0
      tags:
        - packages

    - name: Configure sysctl - kernel panic settings
      ansible.builtin.include_tasks: sysctl-kernel-panic.yml
      tags:
        - sysctl
        - kernel-panic

    - name: Configure sysctl - filesystem optimization
      ansible.builtin.include_tasks: sysctl-filesystem.yml
      tags:
        - sysctl
        - filesystem

    - name: Configure sysctl - network optimization
      ansible.builtin.include_tasks: sysctl-network.yml
      tags:
        - sysctl
        - network

    - name: Configure DNS fallback servers
      ansible.builtin.include_tasks: dns-fallback.yml
      tags:
        - dns

    - name: Configure DNS timeouts and caching
      ansible.builtin.include_tasks: dns-timeouts.yml
      tags:
        - dns

    - name: Configure timezone
      ansible.builtin.include_tasks: timezone.yml
      tags:
        - timezone

    - name: Configure watchdog (RPi only - macb/bcm2835_wdt)
      ansible.builtin.include_tasks: watchdog.yml
      when: inventory_hostname in groups.get('rpi', [])
      tags:
        - watchdog

    - name: Configure CPU governor (RPi only - RP1 RCU stalls)
      ansible.builtin.include_tasks: cpu-governor.yml
      when: inventory_hostname in groups.get('rpi', [])
      tags:
        - cpu-governor

    - name: Configure k3s IO priority
      ansible.builtin.include_tasks: k3s-iopriority.yml
      tags:
        - k3s-iopriority

    - name: Configure PCIe for Raspberry Pi 5
      ansible.builtin.include_tasks: pcie-rpi5.yml
      when: inventory_hostname in groups.get('rpi', [])
      tags:
        - pcie
        - rpi5

    - name: Configure journald volatile storage (RPi only - SD card wear)
      ansible.builtin.include_tasks: journald.yml
      when: inventory_hostname in groups.get('rpi', [])
      tags:
        - journald

    - name: Configure ZFS (storage nodes only)
      ansible.builtin.include_tasks: zfs.yml
      when: inventory_hostname in groups.get('storage', [])
      tags:
        - zfs
        - storage

    - name: Disable firewall services
      ansible.builtin.include_tasks: firewall.yml
      tags:
        - firewall

    - name: Perform system upgrade (optional)
      ansible.builtin.include_tasks: system-upgrade.yml
      when: node_prep_system_upgrade_enabled | bool
      tags:
        - system-upgrade

    - name: Display node preparation summary
      ansible.builtin.debug:
        msg: |
          Node {{ inventory_hostname }} prepared successfully:
          - Hostname set to {{ inventory_hostname }}
          - {{ node_prep_k8s_packages | length }} K8s dependency packages installed
          - {{ node_prep_qol_packages | length }} QoL packages installed
          - {{ node_prep_system_packages | length }} system utility packages installed
          - Kernel panic settings configured
          - Filesystem optimization applied
          - Network optimization applied (BBR, TCP buffers, security)
          - DNS fallback and caching configured
          - Timezone set to {{ node_prep_timezone }}
          {% if inventory_hostname in groups.get('rpi', []) -%}
          - Watchdog configured and running (macb/bcm2835_wdt)
          - CPU governor set to {{ node_prep_cpu_governor }}
          - PCIe Gen 3 and ASPM off configured
          - Journald set to volatile storage ({{ node_prep_journald_runtime_max_use }})
          {% endif -%}
          {% if inventory_hostname in groups.get('storage', []) -%}
          - ZFS ARC configured (zfs_arc_max)
          {% endif -%}
          - k3s IO priority configured (best-effort/0, nice -10)
          - Firewall services disabled
          {% if node_prep_system_upgrade_enabled | bool -%}
          - System upgrade completed
          {% endif -%}
      tags:
        - always

  rescue:
    - name: Display error message
      ansible.builtin.debug:
        msg: "Node preparation failed on {{ inventory_hostname }}. Check apt logs."

    - name: Fail the play
      ansible.builtin.fail:
        msg: "Node preparation failed. See error above."
