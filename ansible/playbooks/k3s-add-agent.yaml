---
# Add new K3s agent (worker) nodes to existing cluster
# Wrapper for k3s-ansible roles with custom configuration
#
# Usage:
# 1. Add new nodes to inventory/production.yaml under "agent" group
# 2. Run: ansible-playbook playbooks/k3s-add-agent.yaml --limit NEW_NODE_NAME
#
# This playbook:
# 1. Prepares the node (sysctl, kernel modules, etc.)
# 2. Installs K3s agent with custom flags
# 3. Joins the node to existing cluster
#
# IMPORTANT: Ensure token is set in group_vars/k3s_cluster.yaml

- name: Prepare new agent nodes
  hosts: agent
  become: true
  gather_facts: true

  pre_tasks:
    - name: Verify node is not already in cluster
      ansible.builtin.command: k3s --version
      register: k3s_check
      changed_when: false
      failed_when: false

    - name: Abort if K3s already installed
      ansible.builtin.fail:
        msg: "K3s is already installed on this node. Use k3s-upgrade.yaml instead."
      when: k3s_check.rc == 0

    - name: Verify cluster token is set
      ansible.builtin.fail:
        msg: "Cluster token is not set. Get token from: sudo cat /var/lib/rancher/k3s/server/token"
      when: token is not defined or token == "REPLACE_WITH_ACTUAL_TOKEN"

  tasks:
    - name: Include prereq role
      ansible.builtin.include_role:
        name: prereq

    - name: Include k3s_agent role
      ansible.builtin.include_role:
        name: k3s_agent

  post_tasks:
    - name: Wait for node to be ready
      ansible.builtin.wait_for:
        timeout: 60

    - name: Verify K3s agent is running
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
      check_mode: true

    - name: Display success message
      ansible.builtin.debug:
        msg: |
          ✓ K3s agent installed successfully on {{ inventory_hostname }}
          ✓ Node should appear in cluster soon
          ✓ Verify with: kubectl get nodes
