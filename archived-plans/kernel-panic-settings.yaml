# System Upgrade Plan: Kernel Panic Settings
#
# Purpose: Configure kernel panic behavior for automatic recovery
#
# What it does:
#   - Sets kernel.panic = 10 (reboot 10 seconds after kernel panic)
#   - Sets kernel.panic_on_oops = 1 (treat kernel oops as panic)
#   - Creates persistent sysctl configuration in /etc/sysctl.d/
#   - Applies settings immediately via sysctl
#
# Why it's needed:
#   - Enables automatic recovery from kernel crashes
#   - Works together with hardware watchdog for complete failover
#   - Prevents nodes from staying in hung state indefinitely
#   - Current settings: panic=0, panic_on_oops=0 (High priority fix)
#
# Behavior: Node will automatically reboot 10 seconds after kernel panic/oops
#
# Idempotency: Checks existing sysctl configuration before making changes
#
---
apiVersion: v1
kind: Secret
metadata:
  name: kernel-panic-secret
  namespace: system-upgrade
type: Opaque
stringData:
  setup.sh: |
    #!/bin/sh
    set -e

    echo "Configuring kernel panic settings on $(hostname)"

    SYSCTL_FILE="/etc/sysctl.d/99-k8s-panic.conf"

    # Check if already configured
    if [ -f "$SYSCTL_FILE" ]; then
      if grep -q "^kernel.panic = 10" "$SYSCTL_FILE" && \
         grep -q "^kernel.panic_on_oops = 1" "$SYSCTL_FILE"; then
        echo "Kernel panic settings already configured, verifying runtime values..."
        CURRENT_PANIC=$(sysctl -n kernel.panic)
        CURRENT_PANIC_ON_OOPS=$(sysctl -n kernel.panic_on_oops)
        if [ "$CURRENT_PANIC" = "10" ] && [ "$CURRENT_PANIC_ON_OOPS" = "1" ]; then
          echo "Runtime values already correct, skipping"
          exit 0
        fi
      fi
    fi

    # Create sysctl configuration
    cat > "$SYSCTL_FILE" <<'EOF'
    # Kernel panic configuration for Kubernetes nodes
    # Automatically reboot on kernel panic for failover

    # Reboot 10 seconds after kernel panic
    kernel.panic = 10

    # Treat kernel oops as panic (automatic recovery)
    kernel.panic_on_oops = 1

    # Panic on out-of-memory condition
    vm.panic_on_oom = 0

    # Panic on hung task (disabled to avoid false positives)
    kernel.hung_task_panic = 0
    EOF

    # Apply settings immediately
    sysctl --system

    # Verify settings
    FINAL_PANIC=$(sysctl -n kernel.panic)
    FINAL_PANIC_ON_OOPS=$(sysctl -n kernel.panic_on_oops)

    if [ "$FINAL_PANIC" = "10" ] && [ "$FINAL_PANIC_ON_OOPS" = "1" ]; then
      echo "Kernel panic settings successfully configured:"
      echo "  kernel.panic = $FINAL_PANIC"
      echo "  kernel.panic_on_oops = $FINAL_PANIC_ON_OOPS"
    else
      echo "ERROR: Failed to configure kernel panic settings"
      echo "  kernel.panic = $FINAL_PANIC (expected: 10)"
      echo "  kernel.panic_on_oops = $FINAL_PANIC_ON_OOPS (expected: 1)"
      exit 1
    fi
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: kernel-panic-settings
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: false
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
  serviceAccountName: system-upgrade
  secrets:
    - name: kernel-panic-secret
      path: /host/run/system-upgrade/secrets
  version: v1.0.0
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky-20251001
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/setup.sh
