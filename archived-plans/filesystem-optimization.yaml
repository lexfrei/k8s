# System Upgrade Plan: Filesystem and VM Optimization
#
# Purpose: Optimize filesystem and virtual memory parameters for Kubernetes
#
# What it does:
#   - Sets vm.swappiness = 1 (minimize swapping, critical for K8s)
#   - Configures vm.dirty_ratio = 10 (aggressive writeback for stability)
#   - Sets vm.dirty_background_ratio = 5 (start background writeback early)
#   - Increases fs.file-max = 2097152 (max open files system-wide)
#   - Sets fs.aio-max-nr = 1048576 (async I/O for databases)
#   - Ensures inotify limits are adequate (524288 watches)
#
# Why it's needed:
#   - vm.swappiness=60 can cause performance issues and OOM kills in K8s
#   - Default dirty ratios can cause I/O stalls under heavy write load
#   - File handle limits prevent "too many open files" errors
#   - AIO limits critical for databases (PostgreSQL, MongoDB, etc.)
#   - Inotify watches needed for file monitoring (kubelet, fluentd, etc.)
#
# Idempotency: Checks existing configuration before making changes
#
---
apiVersion: v1
kind: Secret
metadata:
  name: filesystem-optimization-secret
  namespace: system-upgrade
type: Opaque
stringData:
  setup.sh: |
    #!/bin/sh
    set -e

    echo "Configuring filesystem and VM parameters on $(hostname)"

    SYSCTL_FILE="/etc/sysctl.d/99-k8s-filesystem.conf"

    # Check if already configured
    if [ -f "$SYSCTL_FILE" ]; then
      if grep -q "^vm.swappiness = 1" "$SYSCTL_FILE" && \
         grep -q "^vm.dirty_ratio = 10" "$SYSCTL_FILE" && \
         grep -q "^fs.inotify.max_user_watches = 524288" "$SYSCTL_FILE"; then
        echo "Filesystem parameters already configured, verifying runtime values..."
        CURRENT_SWAPPINESS=$(sysctl -n vm.swappiness)
        CURRENT_DIRTY=$(sysctl -n vm.dirty_ratio)
        CURRENT_WATCHES=$(sysctl -n fs.inotify.max_user_watches)
        if [ "$CURRENT_SWAPPINESS" = "1" ] && [ "$CURRENT_DIRTY" = "10" ] && [ "$CURRENT_WATCHES" = "524288" ]; then
          echo "Runtime values already correct, skipping"
          exit 0
        fi
      fi
    fi

    # Create sysctl configuration
    cat > "$SYSCTL_FILE" <<'EOF'
    # Filesystem and VM configuration for Kubernetes nodes

    # Memory Management
    # -----------------
    # Minimize swapping (critical for K8s performance)
    # Even with swap disabled, this prevents swapping tmpfs/cgroups
    vm.swappiness = 1

    # Dirty page writeback (I/O performance)
    # Start background writeback at 5% dirty pages
    vm.dirty_background_ratio = 5

    # Force synchronous writeback at 10% dirty pages
    # Lower than default (20%) for more predictable I/O
    vm.dirty_ratio = 10

    # Dirty page cache timeout (centiseconds = 15 seconds)
    # Write dirty pages to disk after 15s instead of 30s
    vm.dirty_expire_centisecs = 1500

    # Writeback daemon wakeup interval (centiseconds = 5 seconds)
    vm.dirty_writeback_centisecs = 500

    # File Handle Limits
    # ------------------
    # Maximum number of file handles (system-wide)
    # Default is often too low for K8s clusters
    fs.file-max = 2097152

    # Maximum number of inotify watches per user
    # Kubernetes components (kubelet, fluentd) need many watches
    fs.inotify.max_user_watches = 524288

    # Maximum inotify instances per user
    fs.inotify.max_user_instances = 512

    # Maximum queued events
    fs.inotify.max_queued_events = 65536

    # Async I/O Limits
    # ----------------
    # Maximum concurrent async I/O requests
    # Important for databases (PostgreSQL, MongoDB, MySQL)
    fs.aio-max-nr = 1048576

    # Prevent overly aggressive oom-killer
    # Let memory pressure handling work before OOM
    vm.panic_on_oom = 0

    # Memory overcommit strategy
    # 0 = heuristic (allow reasonable overcommit)
    vm.overcommit_memory = 0
    EOF

    # Apply settings immediately
    sysctl --system

    # Verify critical settings
    FINAL_SWAPPINESS=$(sysctl -n vm.swappiness)
    FINAL_DIRTY=$(sysctl -n vm.dirty_ratio)
    FINAL_WATCHES=$(sysctl -n fs.inotify.max_user_watches)
    FINAL_FILE_MAX=$(sysctl -n fs.file-max)

    if [ "$FINAL_SWAPPINESS" = "1" ] && [ "$FINAL_DIRTY" = "10" ] && \
       [ "$FINAL_WATCHES" = "524288" ] && [ "$FINAL_FILE_MAX" = "2097152" ]; then
      echo "Filesystem parameters successfully configured:"
      echo "  vm.swappiness = $FINAL_SWAPPINESS"
      echo "  vm.dirty_ratio = $FINAL_DIRTY"
      echo "  vm.dirty_background_ratio = $(sysctl -n vm.dirty_background_ratio)"
      echo "  fs.file-max = $FINAL_FILE_MAX"
      echo "  fs.inotify.max_user_watches = $FINAL_WATCHES"
      echo "  fs.aio-max-nr = $(sysctl -n fs.aio-max-nr)"
    else
      echo "ERROR: Failed to configure filesystem parameters"
      echo "  vm.swappiness = $FINAL_SWAPPINESS (expected: 1)"
      echo "  vm.dirty_ratio = $FINAL_DIRTY (expected: 10)"
      echo "  fs.inotify.max_user_watches = $FINAL_WATCHES (expected: 524288)"
      echo "  fs.file-max = $FINAL_FILE_MAX (expected: 2097152)"
      exit 1
    fi
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: filesystem-optimization
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: false
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
  serviceAccountName: system-upgrade
  secrets:
    - name: filesystem-optimization-secret
      path: /host/run/system-upgrade/secrets
  version: v1.0.0
  tolerations:
    - operator: Exists
  upgrade:
    image: ubuntu:plucky-20251001
    command:
      - chroot
      - /host
    args:
      - sh
      - /run/system-upgrade/secrets/setup.sh
