repositories:
  - name: traefik
    url: https://helm.traefik.io/traefik
  - name: metallb
    url: https://metallb.github.io/metallb
  - name: projectcalico
    url: https://docs.tigera.io/calico/charts
  - name: lexfrei-charts
    url: https://lexfrei.github.io/charts
  - name: jetstack
    url: https://charts.jetstack.io

releases:
  # https://github.com/metallb/metallb/tree/main/charts/metallb
  - name: metallb
    namespace: metallb-system
    installed: true
    chart: metallb/metallb

  # https://artifacthub.io/packages/helm/traefik/traefik
  #
  # Check this page before upgrade
  # https://doc.traefik.io/traefik/migration/v2/
  # To avoid the CRD conflict, we need to install the chart with bare helm command.
  # helm upgrade --install traefik traefik/traefik --namespace traefik-system --create-namespace
  # And then apply this file
  - name: traefik
    namespace: traefik-system
    chart: traefik/traefik
    installed: true
    values:
      - service:
          annotations:
            metallb.universe.tf/address-pool: ingress-pool
        additionalArguments:
          # Disable internal ssl check
          - "--serversTransport.insecureSkipVerify=true"
          # entrypoint for cloudflared
          - "--entrypoints.tunnel.address=:8080"
        globalArguments:
          - "--global.checknewversion"
        ports:
          web:
            redirectTo:
              port: websecure
          tunnel:
            port: 8080
            expose: true
            exposedPort: 8080
        ingressRoute:
          dashboard:
            enabled: true
            matchRule: Host(`traefik.k8s.home.lex.la`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
            entryPoints:
              - websecure
        # Ugly hack to avoid the infinite progress on ingresses in argocd
        providers:
          kubernetesIngress:
            publishedService:
              enabled: true

  # https://docs.tigera.io/calico/charts
  - name: calico
    namespace: tigera-operator
    installed: true
    chart: projectcalico/tigera-operator
    values:
      - calicoNetwork:
          ipPools:
            - cidr: "10.42.0.0/16"
              natOutgoing: true
              encapsulation: "VXLAN"

  - name: cloudflared
    chart: lexfrei-charts/cloudflare-tunnel
    namespace: cloudflared-system
    installed: true
    values:
      - cloudflare:
          secretName: tunnel-credentials
          tunnelName: k8s-expose
          ingress:
            - service: http://traefik.traefik-system.svc.k8s.home.lex.la:8080
          enableDefault404: false
        replicaCount: 1

  # https://artifacthub.io/packages/helm/jetstack/cert-manager
  #
  # Cert-manager configred to use Cloudflare DNS challenge
  - name: cert-manager
    namespace: cert-manager
    installed: true
    chart: jetstack/cert-manager
    values:
      - installCRDs: true
        podDnsConfig:
          nameservers:
            - "1.1.1.1"
            - "8.8.8.8"
        dns01RecursiveNameserversOnly: true
        dns01RecursiveNameservers: "8.8.8.8:53,1.1.1.1:53"
