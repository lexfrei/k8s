repositories:
  - name: traefik
    url: https://helm.traefik.io/traefik
  - name: metallb
    url: https://metallb.github.io/metallb
  - name: bugfest
    url: https://bugfest.github.io/tor-controller
  - name: coredns
    url: https://coredns.github.io/helm
  - name: flannel
    url: https://flannel-io.github.io/flannel

releases:
  # Pre-install:
  # Flannel requires CNI plugins to be installed in /opt/cni/bin
  # Check arch in the link below
  #
  # mkdir -p /opt/cni/bin
  # curl -O -L https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-arm-v1.4.0.tgz
  # tar -C /opt/cni/bin -xzf cni-plugins-linux-arm-v1.4.0.tgz
  # rm -rf cni-plugins-linux-arm-v1.4.0.tgz
  #
  # Also you have to create a privileged namespace for flannel manually
  # kubectl create ns kube-flannel
  # kubectl label --overwrite ns kube-flannel pod-security.kubernetes.io/enforce=privileged
  - name: flannel
    namespace: kube-flannel
    installed: true
    chart: flannel/flannel
    values:
      - podCidr: "10.42.0.0/16"
        flannel:
          backend: "wireguard"

  - name: coredns
    namespace: kube-system
    chart: coredns/coredns
    installed: true
    values:
      - rbac:
          create: true
        service:
          clusterIP: 10.43.0.10
        servers:
          - zones:
              - zone: .
            port: 53
            plugins:
              - name: errors
              # Serves a /health endpoint on :8080, required for livenessProbe
              - name: health
                configBlock: |-
                  lameduck 5s
              # Serves a /ready endpoint on :8181, required for readinessProbe
              - name: ready
              # Required to query kubernetes API for data
              - name: kubernetes
                parameters: k8s.home.lex.la in-addr.arpa ip6.arpa
                configBlock: |-
                  pods insecure
                  fallthrough in-addr.arpa ip6.arpa
                  ttl 30
              # Serves a /metrics endpoint on :9153, required for serviceMonitor
              - name: prometheus
                parameters: 0.0.0.0:9153
              - name: forward
                parameters: . /etc/resolv.conf
              - name: cache
                parameters: 30
              - name: loop
              - name: reload
              - name: loadbalance

  # https://github.com/bugfest/tor-controller/tree/master/charts/tor-controller
  - name: tor-controller
    namespace: tor-controller
    installed: true
    chart: bugfest/tor-controller

  # https://github.com/metallb/metallb/tree/main/charts/metallb
  - name: metallb
    namespace: metallb-system
    installed: true
    chart: metallb/metallb

  # https://artifacthub.io/packages/helm/traefik/traefik
  #
  # Check this page before upgrade
  # https://doc.traefik.io/traefik/migration/v2/
  # To avoid the CRD conflict, we need to install the chart with bare helm command.
  # helm upgrade --install traefik traefik/traefik --namespace traefik-system --create-namespace
  # And then apply this file
  - name: traefik
    namespace: traefik-system
    chart: traefik/traefik
    installed: true
    values:
      - service:
          annotations:
            metallb.universe.tf/address-pool: ingress-pool
        additionalArguments:
          # Disable internal ssl check
          - "--serversTransport.insecureSkipVerify=true"
          # SSL for prod
          - "--certificatesresolvers.prodssl.acme.dnschallenge.provider=cloudflare"
          - "--certificatesresolvers.prodssl.acme.storage=/data/acme.json"
          - "--certificatesresolvers.prodssl.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
          - "--entrypoints.websecure.http.tls=true"
          - "--entrypoints.websecure.http.tls.certresolver=prodssl"
        globalArguments:
          - "--global.checknewversion"
        env:
          - name: CF_DNS_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: cf-token
                key: token
        ports:
          web:
            redirectTo:
              port: websecure
        ingressRoute:
          dashboard:
            enabled: false
            matchRule: Host(`traefik.k8s.home.lex.la`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
            entryPoints:
              - websecure
